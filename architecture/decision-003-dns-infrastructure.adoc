:ARC-ID: 003
:ARC-TITLE: Variable-Driven CoreDNS Primary DNS Infrastructure
:ARC-TOPIC: network
:ARC-STATUS: accepted

[#ARCID-{arc-id}]
= {arc-id} - {arc-title}
This decision is part of the {arc-topic} architecture.

== Context

Services within warp bubble require consistent DNS resolution for `*.warp.vsagcrd.org` domains. Certificate validation requires proper DNS resolution matching certificate subject names with service endpoints.

Docker Compose provides automatic forward DNS resolution via network aliases. However, Docker cannot perform reverse DNS lookups (IP → hostname) for custom domain aliases. Applications requiring reverse DNS verification need bidirectional DNS resolution that Docker cannot provide.

== Problem Statement / Motivation

The warp bubble DNS infrastructure must support:

1. **Forward DNS Resolution**: `engineering-console.warp.vsagcrd.org` → `172.20.0.10`
2. **Reverse DNS Resolution**: `172.20.0.10` → `engineering-console.warp.vsagcrd.org`
3. **External DNS Resolution**: Internet domains for package repositories, APIs, etc.
4. **Configuration Simplicity**: Single source of truth for IP/hostname mappings
5. **Maintainability**: Human-readable configuration that minimizes duplication

== Alternatives Considered

**Knockout Criteria**: All options must support both forward DNS (hostname → IP) and reverse DNS (IP → hostname) resolution for `*.warp.vsagcrd.org` domains.

=== External DNS with Public Records

Considered but not viable due to security risks and inability to resolve to private IP addresses.

=== Pure Docker DNS

**FAILS KNOCKOUT CRITERIA**: Cannot perform reverse DNS lookups for custom domain aliases.

.Pro
* Simplest configuration with zero maintenance DNS infrastructure
* Automatic external DNS via host configuration

.Con
* **No reverse DNS support for `*.warp.vsagcrd.org` domains**
* No centralized DNS monitoring or caching

=== CoreDNS Only (Remove Docker Aliases)

.Pro
* **Complete Bidirectional Resolution**: Supports both forward and reverse DNS for custom domains
* Centralized DNS control with single source of truth
* Full control over DNS resolution logic

.Con
* Lose Docker Compose automatic service discovery and readability
* Manual maintenance of hosts files without variable bridge
* No fallback mechanism if CoreDNS fails
* Cannot test partial environment without DNS server

=== Hybrid DNS Routing (Docker Forward + CoreDNS Reverse)

.Pro
* **Complete Bidirectional Resolution**: Combined Docker + CoreDNS provides both forward and reverse
* Docker handles forward DNS automatically
* CoreDNS provides reverse DNS capability

.Con
* Complex DNS routing between multiple systems
* Configuration duplication between aliases and hosts files
* Performance overhead from DNS routing decisions
* Difficult to monitor and troubleshoot DNS issues

=== Variable-Driven CoreDNS Primary (Chosen)

.Pro
* **Complete Bidirectional Resolution**: Supports both forward and reverse DNS for custom domains
* Unified DNS resolution through single server eliminates routing complexity
* Environment variables provide single source of truth for IP/hostname mappings
* Docker aliases retained for compose readability and fallback capability
* Partial environment testing possible without CoreDNS (forward-only via aliases)
* **Ad-hoc Testing Flexibility**: CLI-started containers work immediately with forward DNS via Docker's built-in DNS, can add CoreDNS flags only when reverse DNS needed
* Performance optimization with centralized caching for all queries
* Automatic hosts file generation from environment variables

.Con
* Single point of failure for all DNS resolution
* Additional service dependency and resource usage
* Environment variable management complexity

== Decision Outcome

We will implement a **Variable-Driven CoreDNS Primary Strategy** where:

* **CoreDNS (locator-matrix)** serves as the primary DNS server handling all resolution: forward, reverse, and external
* **Environment variables** provide single source of truth bridging Docker Compose configuration to CoreDNS hosts file generation
* **Docker Compose network aliases** remain for readability and fallback capability but are not used for DNS resolution
* **Automatic hosts file generation** from compact service definitions in environment variables
* All warp bubble services use the subdomain pattern `*.warp.vsagcrd.org`

=== Justification

Since CoreDNS must be in-line for DNS resolution to provide reverse DNS lookups for custom domain aliases, it should handle all DNS queries for optimal performance and consistency. Environment variables serve as the bridge between Docker Compose configuration convenience and CoreDNS hosts file generation, maintaining readability while ensuring bidirectional DNS resolution.

=== Consequences

.Positive
* **Unified DNS Resolution**: Single DNS server handles all queries for consistency
* **Complete Bidirectional Resolution**: Both forward and reverse DNS work properly for custom domains
* **Variable-Driven Configuration**: Environment variables provide single source of truth for IP/hostname mappings
* **Application Compatibility**: Supports applications requiring reverse DNS verification
* **DNS Caching**: CoreDNS provides caching for all queries (internal and external)
* **Performance Optimization**: No DNS routing complexity, all queries resolved by one server
* **Automatic Generation**: Hosts file automatically generated from environment variables
* **Maintainability**: Change IP in one variable affects both compose and CoreDNS

.Negative
* **Single Point of Failure**: CoreDNS service must be running for all DNS resolution
* **Additional Service Dependency**: Cannot use Docker's built-in DNS as fallback
* **Resource Usage**: CoreDNS consumes additional memory and CPU for all DNS queries
* **Configuration Complexity**: Environment variable management required

.Neutral
* **External DNS Behavior**: All external queries forwarded through CoreDNS to host DNS configuration
* **Star Trek Theming**: All themed hostnames preserved via environment variable configuration
* **Docker Aliases**: Network aliases retained for compatibility but not used for DNS resolution

=== Derived / Related Decisions

This decision enhances:
* <<ARCID-001>>: HTTPS Certificates - enables proper certificate validation through reliable DNS resolution
* <<ARCID-002>>: Forward Proxy - supports proxy deployment with internal service discovery
* <<ARCID-004>>: Landing Zone - provides DNS infrastructure for landing zone server external access
* <<ARCID-005>>: Centralized Configuration - implements variable-driven configuration management
* <<ARCID-011>>: Star Trek Naming - preserves all themed hostnames via environment variables
