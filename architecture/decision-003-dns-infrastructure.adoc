= ARCID-003: Pure Docker DNS Infrastructure Within Warp Bubble
:toc: right

== Status
Accepted (Evolved from initial DNS strategy)

== Context
Services within the warp bubble need consistent DNS resolution for *.warp.vsagcrd.org domains regardless of external network configuration. Certificate validation requires proper DNS resolution to match certificate subject names with actual service endpoints.

The warp bubble development environment initially implemented both Docker Compose network aliases and CoreDNS with custom hosts files for internal service discovery. This created redundancy and complexity, as both systems were providing identical DNS resolution for internal `.warp.vsagcrd.org` domains.

Analysis showed Docker Compose automatically provides robust DNS resolution for:
- Service names (optical-data-network, engineering-console, etc.)
- Network aliases (all .warp.vsagcrd.org entries)
- Reverse lookups for container IPs
- Cross-container communication

However, containers still require external DNS resolution to reach internet resources (package repositories, external APIs, etc.), and external DNS servers cannot resolve internal warp bubble service names.

== Problem Statement / Motivation
The evolution of DNS infrastructure in the warp bubble addressed multiple generations of challenges:

=== Initial Challenge (External DNS Dependency)
External DNS servers cannot resolve internal warp bubble service names (e.g., locator-matrix.warp.vsagcrd.org, console.warp.vsagcrd.org). Services need reliable name resolution for inter-service communication and certificate validation. External network changes should not affect internal service discovery.

=== Intermediate Challenge (Dual DNS Implementation)
The dual DNS implementation created:
- **Configuration Duplication**: Same hostnames defined in both docker-compose.yaml aliases and CoreDNS hosts.template
- **Maintenance Overhead**: Updates required in multiple places for hostname changes
- **Complexity**: Understanding which DNS system handled which queries
- **Resource Usage**: Running CoreDNS when Docker's built-in DNS could handle internal resolution

The question became: Is CoreDNS necessary, and if so, what should its role be?

== Alternatives Considered

=== External DNS with Public Records
.Pro
* No additional infrastructure
* Works from anywhere
* Standard DNS resolution

.Con
* Exposes internal network topology
* Security risk with public DNS records
* External dependency for internal services
* Cannot resolve to private IP addresses

=== Option 1: Keep CoreDNS, Remove Aliases
.Pro
* Centralized DNS control
* Single source of truth for hostname resolution
* Custom DNS logic possible
* Full control over DNS resolution
* Private network topology hidden

.Con
* Lose Docker Compose's automatic service discovery
* Manual maintenance of hosts files
* Additional complexity for simple container-to-container communication
* DNS server configuration complexity

=== Option 2: Remove CoreDNS Completely (Chosen)
.Pro
* Simplest configuration
* Let Docker handle all internal DNS automatically
* Reduced resource usage
* No additional service dependencies
* Automatic external DNS via host configuration
* Zero maintenance DNS infrastructure

.Con
* No centralized DNS caching
* No centralized DNS monitoring
* No custom DNS forwarding logic

=== Option 3: Hybrid Approach
.Pro
* Docker handles internal DNS (automatic, no maintenance)
* CoreDNS handles external DNS forwarding with caching
* Clear separation of concerns
* Maintains monitoring and health check capabilities
* Preserves mobile network adaptability (Fritz Box detection)
* Enhanced security through private external DNS forwarding
* Reliable service discovery for internal communications

.Con
* Still runs an additional service
* Slightly more complex than pure Docker DNS
* Additional maintenance overhead
* Unnecessary complexity for basic requirements

== Decision Outcome
We will implement a **Pure Docker DNS Strategy** within the warp bubble where:

* **Docker Compose network aliases** handle all internal `.warp.vsagcrd.org` service discovery
* **Docker's built-in DNS** handles external internet resolution automatically
* Remove CoreDNS (locator-matrix) service entirely
* Eliminate custom DNS server dependency
* Use the subdomain `warp.vsagcrd.org` for all warp bubble services

=== Justification
This pure Docker approach leverages Docker's proven automatic service discovery and built-in external DNS resolution. It eliminates unnecessary complexity while maintaining all functional requirements for certificate validation, service discovery, and external connectivity. Docker automatically handles both internal service resolution via network aliases and external internet access via the host's DNS configuration.

=== Implementation Details

==== Docker Compose Network Aliases
* Retain all existing network aliases for service discovery
* Remove custom DNS server configuration from all containers
* Internal communication uses automatic Docker DNS
* External resolution uses Docker's built-in DNS forwarding to host

==== Simplified Service Architecture
* Remove locator-matrix (CoreDNS) service entirely
* All containers use Docker's default DNS behavior
* Network aliases provide FQDN resolution for certificate validation
* Host DNS configuration automatically handles external resolution

==== Testing Strategy
* Diagnostic-array container for comprehensive DNS testing
* Validation of both internal service discovery and external resolution
* Forward and reverse DNS lookup verification
* External connectivity testing (package installation, git operations)

== Consequences

=== Positive
* **Maximum Simplicity**: Elimination of all custom DNS infrastructure
* **Automatic Service Discovery**: Docker handles internal DNS without any configuration
* **Zero Maintenance**: No DNS configuration files to maintain
* **Reduced Resource Usage**: No additional DNS service running
* **Reliability**: Leverages Docker's proven built-in DNS mechanisms
* **Enhanced Security**: Private network topology hidden from external DNS
* **Network Independence**: External network changes don't affect internal service discovery
* **Simplified Architecture**: Fewer moving parts, easier to understand and debug

=== Negative
* **No DNS Caching**: Each external query hits upstream DNS directly
* **No DNS Monitoring**: Cannot track DNS query patterns or performance
* **No Custom DNS Logic**: Cannot implement special DNS forwarding rules

=== Neutral
* **External DNS Behavior**: Uses host DNS configuration automatically
* **Star Trek Theming**: All themed hostnames preserved via Docker aliases
* **Certificate Validation**: Proper DNS resolution maintained for certificate subject names

== Compliance
This decision enhances:
* <<ARCID-001>>: HTTPS Certificates - enables proper certificate validation through reliable DNS resolution
* <<ARCID-002>>: Forward Proxy - supports proxy deployment with internal service discovery
* <<ARCID-004>>: Landing Zone - provides DNS infrastructure for landing zone server external access
* <<ARCID-005>>: Centralized Configuration - simplifies DNS configuration management
* <<ARCID-011>>: Star Trek Naming - preserves all themed hostnames via Docker aliases

== Testing
A diagnostic-array container validates:
1. Internal service discovery via all aliases
2. External DNS resolution via host configuration
3. Forward and reverse DNS lookups
4. Cross-container communication
5. External connectivity (package repositories, git operations)

== Notes
This pure Docker DNS approach represents the ultimate evolution from complex dual-DNS systems to the simplest possible configuration that still meets all functional requirements. By eliminating custom DNS infrastructure entirely, we achieve maximum reliability while reducing maintenance overhead to zero. Docker's built-in capabilities prove sufficient for all warp bubble DNS requirements including security, service discovery, and external connectivity.
